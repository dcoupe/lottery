function in_array(b,c){for(var a=0;a<c.length;a++){if(b==c[a]){return true}}return false}function array_find(c,b){for(var a=0;a<c.length;a++){if(b==c[a]){return a}}return -1}function array_del(d,c){var a=[];for(var b=0;b<d.length;b++){if(c!=d[b]){a.push(d[b])}}return a}function array_del_all(d,b){var a=[];for(var c=0;c<d.length;c++){if(array_find(b,d[c])==-1){a.push(d[c])}}return a}function array_slice(c,d,b){var a;a=c.slice(d,d+b);if(a.length<b){a=a.concat(c.slice(0,b-a.length))}return a}function array_shuffle(d){var a=d.length;for(var c=0;c<a*5;c++){var f=parseInt(a*Math.random());var e=parseInt(a*Math.random());var b=d[f];d[f]=d[e];d[e]=b}}var Game=function(){var a=this;this.step=-1;this.interval=100;this.rotate_index=0;a.action="open";this.prizes=[];this.candidates=[];this.results=[];this.init=function(){this.step=0;this.stop=false;this.rotate_index=0;a.action="open";this.results=[];for(var b=0;b<a.prizes.length;b++){var c=a.prizes[b];a.results[b]=[]}show_current_step("");var d="请按空格键开始";d+="<br/><br/>";print_box("请按空格键开始");$("#rolling_board").hide();$("#rotate_div").css("background","")};this.reset=function(){this.prizes=[];this.candidates=[];this.results=[]};this.process=function(){show_results();switch(a.action){case"open":a.action="step_open";$("#rotate_div").hide();on_open();$("#rotate_div").fadeIn("slow");break;case"close":a.action="";on_close();break;case"step_open":a.action="rotate_start";$("#rotate_div").hide();on_step_open();$("#rotate_div").fadeIn("fast");break;case"step_close":if(a.step==a.prizes.length){a.action="close"}else{a.action="step_open"}on_step_close();break;case"rotate_start":a.action="rotate_stop";on_rotate_start();break;case"rotate_stop":on_rotate_stop();break;default:save_setting();break}}};function on_open(){show_current_step("奖项设置");var c='<table class="table table-bordered" style="background:#fff">';c+="<tr><th>奖项</th><th>数量</th><th>奖品</th></tr>\n";for(var a=game.prizes.length-1;a>=0;a--){var b=game.prizes[a];c+="<tr><td>"+b.name+"</td><td>"+b.num+"</td><td>"+b.award+"</td></tr>\n"}c+="</table>";print_box(c)}function on_close(){show_current_step("");$("#print_box").hide();var a="";a+="<span><b>抽奖结束</b></span>";print_box(a)}function on_step_open(){show_current_step();print_box("按空格键开始");$("#rolling_board").html("...")}function on_step_close(){var b="";b+='<span style="font-size:30px;">&nbsp;* 中奖名单 *&nbsp;</span><br/><br/><br/><span style="color: #D14; font-size:40px; font-weight:700;">';var a=game.results[game.step-1];for(var c=0;c<a.length;c++){b+=a[c]+"<br/><br/>"}b+="</span>";print_box(b);$("#rolling_board").slideUp("normal")}function on_rotate_start(){$("#rolling_board").slideDown("normal");game.interval=parseInt($("input[name=interval]").val());game.stop=false;game.rotate_index=0;array_shuffle(game.candidates);rotate_run();show_current_step();print_box("按空格键停止")}function on_rotate_stop(){game.interval+=parseInt(0.9*game.interval);setTimeout("game.stop=true",230+parseInt(230*Math.random()))}function rotate_run(){var d=game.prizes[game.step].num_a_time;var b=game.prizes[game.step].num-game.results[game.step].length;if(b>d){b=d}var a=array_slice(game.candidates,game.rotate_index,b);$("#rolling_board").html(a.join(" "));game.rotate_index+=d;if(game.rotate_index>=game.candidates.length){game.rotate_index-=game.candidates.length}if(game.stop){game.action="rotate_start";game.results[game.step]=game.results[game.step].concat(a);game.candidates=array_del_all(game.candidates,a);show_results();print_box("按空格键继续");if(game.results[game.step].length==game.prizes[game.step].num){game.step++;game.action="step_close"}var c='<span style="color: #D14">'+$("#rolling_board").html()+"</span>";$("#rolling_board").html(c)}else{setTimeout("rotate_run()",game.interval)}}function show_current_step(f){if(f==undefined){var d=game.results[game.step].length;var c=game.prizes[game.step].num;var e=game.prizes[game.step].num_a_time;var a=(e+d)>c?c:(e+d);var f=game.prizes[game.step].name+"("+game.prizes[game.step].num+"个";if(e!=c){f+=", "+(d+1)+"-"+a}f+=")"}if(f==""){$("#current_step").hide("fast")}else{$("#current_step").html(f);$("#current_step").show()}}function print_box(b){if(b==undefined){var b="<span>";var a=game.results[game.step];for(var c=0;c<a.length;c++){b+=a[c]+" &nbsp;"}b+="</span>"}if(b==""){$("#print_box").hide("fast")}else{$("#print_box").html(b);$("#print_box").show()}}function show_results(){var c="";for(var a=game.results.length-1;a>=0;a--){c+="<label>"+game.prizes[a].name+":</label>";var b=game.results[a];for(var d=0;d<b.length;d++){c+="<span>"+b[d]+"</span>"}c+="<br/>"}$("#result").html(c)}function save_setting(){var f="";game.reset();var e=$.trim($("textarea[name=prizes]").val()).split("\n");for(var b=0;b<e.length;b++){var d=$.trim(e[b]);if(d.length==0){continue}var a=d.split("|");var c={name:$.trim(a[0]),num:parseInt($.trim(a[1])),num_a_time:parseInt($.trim(a[2])),award:$.trim(a[3])};game.prizes.push(c)}var e=$.trim($("textarea[name=candidates]").val()).replace(/,/g,"\n").split("\n");
for(var b=0;b<e.length;b++){var d=$.trim(e[b]);if(d.length==0){continue}game.candidates.push(d);f+="<span>"+d+"</span>"}$("#candidate").html(f);$("#event_title span").html($("input[name=title]").val());game.init()};